name: release-please
on:
  push:
    branches:
      - main
jobs:
  release-please:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    outputs:
      release-created: ${{ steps.release.outputs.release_created }}
      tag-name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@16a9c90856f42705d54a6fda1823352bdc62cf38
        id: release
        with:
          config-file: .release-please-config.json
          manifest-file: .release-please-manifest.json

      - name: Find release PR
        id: find-pr
        run: |
          set -euo pipefail
          REPO="${GITHUB_REPOSITORY}"
          PR_JSON=$(gh pr list --repo "$REPO" --label "autorelease: pending" --json number,headRefName --limit 1 || echo '[]')
          # Ensure jq is available (GitHub hosted runners have it by default)
          if ! command -v jq >/dev/null 2>&1; then
            echo "jq not found; cannot parse release PR JSON" >&2
            PR_NUMBER=""
            PR_BRANCH=""
          else
            PR_NUMBER=$(jq -r '.[0].number // ""' <<< "$PR_JSON")
            PR_BRANCH=$(jq -r '.[0].headRefName // ""' <<< "$PR_JSON")
          fi
          if [ -n "$PR_NUMBER" ]; then
            echo "Found release PR #$PR_NUMBER on branch $PR_BRANCH"
          else
            echo "No active release PR found (label: autorelease: pending)."
          fi
          echo "pr-number=$PR_NUMBER" >> "$GITHUB_OUTPUT"
          echo "pr-branch=$PR_BRANCH" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Assign release PR to viamin
        if: steps.find-pr.outputs.pr-number != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd
        env:
          PR_NUMBER: ${{ steps.find-pr.outputs.pr-number }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = Number(process.env.PR_NUMBER);
            if (!prNumber) {
              console.log('Release PR number missing; skipping assignee update.');
              return;
            }
            await github.rest.issues.addAssignees({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              assignees: ['viamin']
            });
            console.log(`Assigned release PR #${prNumber} to viamin.`);

  publish:
    needs: release-please
    if: ${{ needs.release-please.outputs.release-created }}
    runs-on: ubuntu-latest
    permissions:
      id-token: write # Required for OIDC
      contents: read
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8
      - uses: actions/setup-node@2028fbc5c25fe9cf00d9f06a71cc4710d4507903
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'
      - name: Update npm
        run: npm install -g npm@latest
      - run: npm ci
      - run: npm run build
      - run: npm test
      - run: npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      - name: Comment on PRs included in release
        uses: apexskier/github-release-commenter@3bd413ad5e1d603bfe2282f9f06f2bdcec079327
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          comment-template: |-
            ðŸŽ‰ This PR is included in version {release_name} ðŸŽ‰

            The release is available on:

            - [npm package](https://www.npmjs.com/package/homebridge-rise-garden) (@latest dist-tag)
            - [GitHub release]({release_link})

            Your release-please bot ðŸ“¦ðŸš€
